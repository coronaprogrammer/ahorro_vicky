<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Ahorro de Victoria</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f0f0; text-align: center; }
    h1 { margin-top: 20px; }
    .tabs { display: flex; justify-content: center; margin: 20px; }
    .tab { padding: 10px 20px; cursor: pointer; background: #ddd; margin: 0 5px; border-radius: 5px; }
    .tab.active { background: #333; color: #fff; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .battery {
      width: 200px; height: 400px; border: 5px solid #333;
      border-radius: 15px; margin: 40px auto; position: relative; background: #fff;
    }
    .battery::after {
      content: ""; width: 80px; height: 20px; background: #333;
      position: absolute; top: -25px; left: 60px; border-radius: 5px;
    }
    .level {
      position: absolute; bottom: 0; width: 100%; border-radius: 10px;
      text-align: center; color: #fff; font-weight: bold; font-size: 20px;
    }
    table { margin: 20px auto; border-collapse: collapse; width: 80%; }
    th, td { border: 1px solid #333; padding: 8px; }
    th { background: #ddd; }
  </style>
</head>
<body>
  <h1>游눯 Ahorro de Victoria</h1>
  <p>Meta: <strong>1,800 MXN</strong></p>

  <!-- Pesta침as -->
  <div class="tabs">
    <div class="tab active" onclick="showTab(0)">Resumen</div>
    <div class="tab" onclick="showTab(1)">Hist칩rico</div>
  </div>

  <!-- Contenido pesta침a 1 -->
  <div class="tab-content active">
    <div class="battery">
      <div class="level" id="level"></div>
    </div>
    <p id="info"></p>
    <h2>Resumen por persona</h2>
    <canvas id="graficaResumen" width="100" height="100"></canvas>
  </div>

  <!-- Contenido pesta침a 2 -->
  <div class="tab-content">
    <h2>Hist칩rico de aportaciones</h2>
    <table id="tabla">
      <thead><tr><th>Fecha</th><th>Persona</th><th>Monto</th><th>Tipo</th></tr></thead>
      <tbody></tbody>
    </table>
    <h2>Evoluci칩n del ahorro</h2>
    <canvas id="grafica" width="400" height="200"></canvas>
  </div>

  <!-- Librer칤as -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>

  <script>
    const meta = 1800;
    const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRzSEueTdKbwNKU5R0PS_lBFlivF_f8lzMSsv2YbKk_KwMD_FiRAup1A1AH9RI6iqQmBKpcE5x7bI8v/pub?gid=0&single=true&output=csv";

    function showTab(index) {
      document.querySelectorAll(".tab").forEach((t,i)=>t.classList.toggle("active", i===index));
      document.querySelectorAll(".tab-content").forEach((c,i)=>c.classList.toggle("active", i===index));
    }

    async function cargarDatos() {
      const response = await fetch(sheetURL);
      const text = await response.text();
      const rows = text.split("\n").map(r => r.split(","));

      let total = 0;
      let resumen = {};
      let fechas = [], acumulado = [];

      const tbody = document.querySelector("#tabla tbody");
      tbody.innerHTML = "";

      rows.slice(1).forEach(r => {
        if (r.length < 4) return;
        const [fecha, persona, monto, tipo] = r;
        const valor = parseFloat(monto);
        total += valor;

        // hist칩rico
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${fecha}</td><td>${persona}</td><td>${monto}</td><td>${tipo}</td>`;
        tbody.appendChild(tr);

        // resumen
        if (!resumen[persona]) resumen[persona] = 0;
        resumen[persona] += valor;

        // evoluci칩n
        fechas.push(fecha);
        acumulado.push(total);
      });

      // bater칤a
      const porcentaje = Math.min((total / meta) * 100, 100);
      const level = document.getElementById("level");
      const info = document.getElementById("info");
      level.style.height = porcentaje + "%";
      let color = "red";
      if (porcentaje >= 25) color = "orange";
      if (porcentaje >= 50) color = "yellow";
      if (porcentaje >= 75) color = "green";
      level.style.background = color;
      level.textContent = Math.round(porcentaje) + "%";
      info.textContent = `Ahorro actual: ${total} MXN de ${meta} MXN`;

      // gr치fica de pastel (resumen por persona)
      const personas = Object.keys(resumen);
      const montos = Object.values(resumen);
      const colores = ["#ff6384","#36a2eb","#ffcd56","#4bc0c0","#9966ff","#ff9f40"];

      new Chart(document.getElementById("graficaResumen"), {
        type: 'pie',
        data: {
          labels: personas,
          datasets: [{
            data: montos,
            backgroundColor: colores.slice(0, personas.length)
          }]
        },
        options: {
          plugins: {
            legend: { position: 'bottom' },
            datalabels: {
              formatter: (value, ctx) => {
                let sum = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
                let percentage = (value / sum * 100).toFixed(1) + "%";
                return percentage;
              },
              color: '#fff',
              font: { weight: 'bold', size: 14 }
            }
          }
        },
        plugins: [ChartDataLabels]
      });

      // gr치fica evoluci칩n con l칤nea de meta
      new Chart(document.getElementById("grafica"), {
        type: 'line',
        data: {
          labels: fechas,
          datasets: [{
            label: 'Ahorro acumulado',
            data: acumulado,
            borderColor: 'blue',
            fill: false
          }]
        },
        options: {
          plugins: {
            annotation: {
              annotations: {
                lineaMeta: {
                  type: 'line',
                  yMin: meta,
                  yMax: meta,
                  borderColor: 'red',
                  borderWidth: 2,
                  label: {
                    content: 'Meta 1800 MXN',
                    enabled: true,
                    position: 'end'
                  }
                }
              }
            }
          }
        }
      });
    }

    cargarDatos();
  </script>
</body>
</html>